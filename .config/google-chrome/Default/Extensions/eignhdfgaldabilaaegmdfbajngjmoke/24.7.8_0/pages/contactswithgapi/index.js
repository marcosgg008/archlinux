"use strict";cjce.registerTemplate("bm-p-contactswithgapi",function(r,s){var l,o,d,m,u,t,p="https://contacts.google.com/"+s.wizPath,a="https://people.googleapis.com/v1/",n="https://www.google.com/m8/feeds/",c=["https://www.googleapis.com/auth/contacts.readonly"],i=Math.ceil(40*window.devicePixelRatio),h=p,f="home",b=null,_=0,g=25,j=["contactGroups/coworkers","contactGroups/family","contactGroups/friends"],y=!1,v=browserStorage.sync.getItem("bm_pref__contacts__lastname").then(function(e){y=Boolean(e)}),C="connections(resourceName,names(displayName,displayNameLastFirst),photos/url,memberships/contactGroupMembership/contactGroupId),nextPageToken",e=null,N=!1,w=function(){if(cjgApis.info.getIsConsumerGmail(s.account))return Promise.resolve(!1);return cjgApis.cache.getItem(s.account,"bm_pref__contacts__directory").then(function(e){return"boolean"==typeof e?e:k().then(function(){return!0},function(){return!1}).then(function(e){return cjgApis.cache.setItem(s.account,"bm_pref__contacts__directory",e),e})})}().then(function(e){e&&(N=!0,C=C.replace("resourceName,","resourceName,metadata/sources(type,id),"))}),E=!1,A={};function L(e,t){_=0,u.cjceSetLoading(!0),f=e,b=t,E&&F()}function T(){Promise.all([cjgApis.cache.getItem(s.account,"bm_cache_v31__contacts__library"),v]).then(function(e){E||(l=e[0])&&(E=!0,F())}),Promise.all([w,v]).then(function(e){var t=function(e,t,n,a){var c=n||[];e="other"===e?"otherContacts":"people/me/connections";return S(e,{pageToken:a,pageSize:"2000",personFields:"memberships,metadata,names,photos",fields:C,sortOrder:t}).then(function(e){if(!Array.isArray(e.connections))return c;e.connections.forEach(function(e){e=I(e);e&&c.push(e)});e.nextPageToken;return c})}("main",y?"LAST_NAME_ASCENDING":"FIRST_NAME_ASCENDING");return N?Promise.all([k().then(P),t]).then(function(e){var t=e[0],e=e[1],n=t.map(function(e){return e.id});return e.forEach(function(e){-1===n.indexOf(e.id)&&t.push(e)}),U(t),t}):t}).then(function(e){E=!0,l&&JSON.stringify(l).length===JSON.stringify(e).length||(cjgApis.cache.setItem(s.account,"bm_cache_v31__contacts__library",e),l=e,F())})}function S(t,n){var e=n||{};e.prettyPrint="false";e=cjBasics.urlParams.attach(a+t,e);return cjgApis.request(e,{fetchAs:"json"},{account:s.account,requiredScopes:c}).catch(function(){return new Promise(function(e){setTimeout(function(){S(t,n).then(e)},4e3)})})}function B(){return cjce.createElement("gmd-fab",{label:cjBasics.lang.i18n("cj_i18n_01285","Create contact"),onClick:function(){s.openTab(p+"new")}})}function G(e,t){return"string"!=typeof e||e.length<5?"/images/avatar.svg":(e=(e=e.startsWith("http://")?e.replace("http://","https://"):e).startsWith("https://www.google.com/s2/")?e.replace("www","profiles"):e)+"?sz="+(t||"40")}function I(e){var t=function(e){var t=e.resourceName;if(!N||!t.startsWith("people/c"))return t;var n=e.metadata&&e.metadata.sources;if(!Array.isArray(n))return t;for(var a=0;a<n.length;a++)if("DOMAIN_PROFILE"===n[a].type)return"people/"+n[a].id;return t}(e),n=e&&e.names&&e.names[0]||A[t];if(n){var a=n.displayName||"",c=n.displayNameLastFirst||a;if(a){n=[];return Array.isArray(e.memberships)&&(n=e.memberships.map(function(e){return e.contactGroupMembership?e.contactGroupMembership.contactGroupId:"GSUITE_DIRECTORY_GROUP"})),{id:t,displayName:a,displayNameLastFirst:c,sortValue:a.toLowerCase(),sortValueLastFirst:c.toLowerCase(),photo:e.photos&&e.photos[0].url||null,memberships:n}}}}function P(e){for(var t=[],n=[],a=0;a<e.length;a+=50){var c=S("people:batchGet",{resourceNames:e.splice(0,50),fields:"responses(requestedResourceName,person(names(displayName,displayNameLastFirst),photos/url,memberships/contactGroupMembership/contactGroupId))",personFields:"names,photos,memberships"}).then(function(e){e.responses.forEach(function(e){e.person.resourceName=e.requestedResourceName;e=I(e.person);e&&t.push(e)})});n.push(c)}return Promise.all(n).then(function(){return t})}function k(){return e=e||cjgApis.info.getUserDomain(s.account).then(function(e){e=cjBasics.urlParams.attach(n+"gal/"+(e||"default")+"/full",{alt:"json","max-results":"50000"});return cjgApis.request(e,{fetchAs:"json",headers:{"GData-Version":"1.0"}},{account:s.account,requiredScopes:c})}).then(function(e){var i=[],e=e&&e.feed&&e.feed.entry;return Array.isArray(e)&&e.forEach(function(e){var t,n,a,c=function(e){if(!(e=e.id&&e.id.$t&&e.id.$t.split("full/P.")[1]))return null;for(var t=cjBasics.numbers.hex2dec(e);t.length<20;)t="0"+t;return t=t.length<21?"1"+t:t}(e);c&&(n=t="people/"+c,(c=(a=e).gd$name)&&(e=c.gd$fullName&&c.gd$fullName.$t,a=c.gd$givenName&&c.gd$givenName.$t,c=c.gd$familyName&&c.gd$familyName.$t,A[n]={displayName:e||a||c,displayNameLastFirst:c&&a?c+", "+a:null}),i.push(t))}),i})}function O(t){return l.filter(function(e){return-1!==e.memberships.indexOf(t)})}function x(e,t){var a=document.createDocumentFragment();t.forEach(function(e){var t,n,e=(t=e,n=y&&t.displayNameLastFirst||t.displayName,e={withShell:!0,size:40},t.photo?(e.url=G(t.photo,i),e.color="#fff"):e.symbol=n[0]||" ",(e=cjce.createElement("cjmd-item",{icon:e,label:n})).classList.add("bm-p-contactswithgapi-listitem"),e.cjceContactsData=t,(n=cjce.createElement("cjmd-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_06290","Edit contact"),iconName:"__mdi:edit",onClick:function(){$(t.id,!0)}})).classList.add("bm-p-contactswithgapi-listitem__tool"),e.appendChild(n),(n=cjce.createElement("cjmd-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_01545","Open in a new tab"),iconName:"__mdi:open_in_new",onClick:function(){$(t.id)}})).classList.add("bm-p-contactswithgapi-listitem__tool"),e.appendChild(n),e);a.appendChild(e)}),e.appendChild(a)}function F(){u.cjceSetLoading(!0);var n,e,t,a,c,i=null,o=cjce.createElement("cjmd-container",{scrollable:!0,fabPadding:!0,infiniteScroll:!0,shadow:"thinOnScroll"});"home"===f?(0<(e=O("starred")).length&&(c=cjce.createElement("cjmd-subheader",{color:!0,label:cjBasics.lang.i18n("cj_i18n_00004","Starred")}),o.appendChild(c),x(c=cjce.createElement("cjmd-list"),e),o.appendChild(c),c=cjce.createElement("cjmd-subheader",{color:!0,label:cjBasics.lang.i18n("cj_i18n_00314","Contacts")}),o.appendChild(c)),n=O("myContacts")):"search"===f?(t=b,n=l.filter(function(e){return-1!==JSON.stringify(e).indexOf(t)})):"directory"===f?n=O("GSUITE_DIRECTORY_GROUP"):"other"===f?n=O("SPECIAL_OTHER"):"label"===f&&(n=O(b)),0<n.length?(a=cjce.createElement("cjmd-list"),function e(t){i=null,_+=g;t=n.splice(0,t?_:g);x(a,t),n.length&&(i=e,o.cjceSetInfiniteScroll(function(){i&&i()}))}(!0),o.appendChild(a)):(c=f,c=cjce.createElement("cjmd-emptystate",{color:!0,label:cjBasics.lang.i18n("cj_i18n_01275","No contacts found"),subLabel:"search"===c?cjBasics.lang.i18n("cj_i18n_00116","Try a synonym or more general keyword"):null,iconName:"search"===c?"__mdi:search":"__mdi:contacts_product"}),o.appendChild(c)),d.textContent="",d.appendChild(o),u.cjceSetLoading(!1)}function R(e,t){var n=t.resourceName.replace("contactGroups/",""),a=t.formattedName,c=a,t=t.memberCount;0<t&&(c+=" ("+t+")"),e.push({id:n,iconName:"__mdi:label",label:c,navigatorLabel:a,newTabUrl:p+"label/"+n})}function U(e){var n=y?"sortValueLastFirst":"sortValue";e.sort(function(e,t){return e[n]<t[n]?-1:1})}function D(){cjce.applyTemplate(m,"bm-loading");var a=[{id:"home",label:cjBasics.lang.i18n("cj_i18n_00314","Contacts"),navigatorLabel:cjBasics.lang.i18n("cj_i18n_00291","Home"),iconName:"__mdi:person",newTabUrl:p,divider:!0}],c=[{label:cjBasics.lang.i18n("cj_i18n_01276","Frequently contacted"),iconName:"__mdi:history",newTabUrl:p+"frequent",external:!0},{label:cjBasics.lang.i18n("cj_i18n_01277","Duplicates"),iconName:"__mdi:assistant",newTabUrl:p+"merge",external:!0},{label:cjBasics.lang.i18n("cj_i18n_01278","Other contacts"),iconName:"__mdi:archive",newTabUrl:p+"other",divider:!0}],i=document.createElement("div");m.appendChild(i);var e=S("contactGroups",{pageSize:"500",fields:"contactGroups(resourceName,groupType,formattedName,memberCount)"});Promise.all([e,v,w]).then(function(e){var n=[];N&&(a[0].divider=!1,a.push({id:"directory",label:cjBasics.lang.i18n("cj_i18n_01279","Directory"),iconName:"__mdi:business",newTabUrl:p+"directory",divider:!0})),e[0].contactGroups.forEach(function(e){var t;"USER_CONTACT_GROUP"===e.groupType?R(n,e):"contactGroups/myContacts"===e.resourceName?0<(t=e.memberCount)&&(a[0].label+=" ("+t+")"):-1!==j.indexOf(e.resourceName)&&0<e.memberCount&&R(n,e)}),0<n.length&&(a.push({header:!0,label:cjBasics.lang.i18n("cj_i18n_01280","Labels")}),n.sort(function(e,t){return e.label.toLowerCase()<t.label.toLowerCase()?-1:1}),n[n.length-1].divider=!0,a=a.concat(n)),a=a.concat(c),o=cjce.createElement("bm-navlist",{compact:!0,isSelector:!0,selectedId:"home",items:a,onChange:function(e,t){h=t.newTabUrl||p,"home"===e||"directory"===e||"other"===e?L(e):L("label",e),u.cjceSetPageLabel(t.navigatorLabel||t.label)},onNewTab:function(e,t){s.openTab(t.newTabUrl)}}),i.appendChild(o);var t=cjce.createElement("bm-drawerdropdown",{iconName:"__mdi:cj_sort_by_alpha",label:cjBasics.lang.i18n("cj_i18n_01281","Sort"),selectedId:y?"last":"first",items:[{value:"last",label:cjBasics.lang.i18n("cj_i18n_01282","Sort by last name")},{value:"first",label:cjBasics.lang.i18n("cj_i18n_01283","Sort by first name")}],onChange:function(){var e;e="last"===t.cjceSelectedId,y=e,browserStorage.sync.setItem("bm_pref__contacts__lastname",y),E&&(U(l),F())}});m.appendChild(t),m.cjceSetLoading(!1)})}function q(e){var t=cjce.createElement("cjmd-item");e.onClick?t.addEventListener("click",function(){e.onClick()}):t.classList.add("no-action");var n=cjce.createElement("cjmd-icon",{name:e.iconName});t.appendChild(n);var a=document.createElement("div");a.className="cjmd-item__body",t.appendChild(a);n=document.createElement("div");return n.className="cjmd-item__header",n.textContent=e.value,a.appendChild(n),e.subLabel&&(n=cjce.createElement("cjmd-secondarytext",{label:e.subLabel}),a.appendChild(n)),t}function $(e,t){e=p+e.replace("people/","person/");t&&(e+="?edit=true"),s.openTab(e)}function M(e){e=encodeURIComponent(e);s.openTab(p+"search/"+e)}function V(){var e=o.cjceSelectedId;"home"===e||"directory"===e||"other"===e?L(e):L("label",e)}!function(){u=cjce.createElement("bm-ogb",{loading:!0,drawer:!0,serviceIcon:"contacts",serviceLabel:cjBasics.lang.i18n("cj_i18n_00314","Contacts"),pageLabel:cjBasics.lang.i18n("cj_i18n_00291","Home"),searchbox:{color:!0,onClear:V,onInput:function(e){e?L("search",e):V()},onSubmit:function(){d.querySelector(".cjmd-item").click()},onMetaSubmit:M},bmApis:s,onNewTab:function(){"search"===f?M(b):s.openTab(h)}}),r.appendChild(u),m=u.cjceDrawerEl,t=u.cjceSearchboxEl;var e=B();r.appendChild(e),s.setOnPageDisplayHandler(t.select),(d=cjce.createElement("cjmd-container")).addEventListener("click",function(e){e=e.target.cjceContactsData;e&&function(e){var t=cjce.createElement("cjmd-container",{solid:!0});t.classList.add("bm-p-contactswithgapi-details");var n=cjce.createElement("bm-ogb",{floating:!0,displayBack:!0,onBack:function(){t.remove()},bmApis:s,onNewTab:function(){$(e.id)}});t.appendChild(n);var a=cjce.createElement("cjmd-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_06290","Edit contact"),iconName:"__mdi:edit",onClick:function(){$(e.id,!0)}});n.cjceAppendChild(a);var c=document.createElement("div");c.className="bm-p-contactswithgapi-details__top",t.appendChild(c);var i=y&&e.displayNameLastFirst||e.displayName,n=Math.ceil(80*window.devicePixelRatio),a={withShell:!0,size:80};e.photo?(a.url=G(e.photo,n),a.color="#b3b3b3"):a.symbol=i[0]||" ",(a=cjce.createElement("cjmd-icon",a)).classList.add("bm-p-contactswithgapi-details__photo"),c.appendChild(a),(i=cjce.createElement("cjmd-title",{label:i})).classList.add("bm-p-contactswithgapi-details__name"),c.appendChild(i),i=cjce.createElement("cjmd-container",{scrollable:!0,shadow:"thickOnScroll"}),t.appendChild(i);var o=cjce.createElement("cjmd-list");i.appendChild(o),S(e.id,{fields:"addresses,birthdays,emailAddresses,phoneNumbers"}).then(function(e){var n=document.createDocumentFragment();Array.isArray(e.emailAddresses)&&0<e.emailAddresses.length&&e.emailAddresses.forEach(function(e){var t=q({iconName:"__mdi:email",value:e.value,subLabel:e.formattedType,onClick:function(){s.openTab("mailto:"+e.value)}});n.appendChild(t)}),Array.isArray(e.phoneNumbers)&&0<e.phoneNumbers.length&&e.phoneNumbers.forEach(function(e){var t=q({iconName:"__mdi:call",value:e.value,subLabel:e.formattedType,onClick:function(){s.openTab(cjBasics.urlParams.attach("https://hangouts.google.com/",{authuser:s.account.authuser,pn:e.canonicalForm,action:"chat"}))}});n.appendChild(t)}),Array.isArray(e.addresses)&&0<e.addresses.length&&e.addresses.forEach(function(e){var t=q({iconName:"__mdi:place",value:e.formattedValue,subLabel:e.formattedType,onClick:function(){s.openTab(cjBasics.urlParams.attach("https://maps.google.com/",{authuser:"0"===s.account.authuser?null:s.account.authuser,q:e.formattedValue}))}});n.appendChild(t)}),Array.isArray(e.birthdays)&&0<e.birthdays.length&&e.birthdays.forEach(function(e){e=q({iconName:"__mdi:cake",value:e.text});n.appendChild(e)}),0===n.children.length&&((e=document.createElement("div")).className="bm-p-contactswithgapi-noinfo",e.textContent=cjBasics.lang.i18n("cj_i18n_01284","No more contact info found"),n.appendChild(e)),o.appendChild(n),u.cjceSetLoading(!1)}),r.appendChild(t)}(e)}),r.appendChild(d),T(),D(),cjgApis.auth.requireToken(s.account,c).catch(function(e){var t=cjce.createElement("bm-fulldialog",{bmApis:s,onNewTab:function(){s.openTab(h)},lockup:{label:cjBasics.lang.i18n("cj_i18n_00314","Contacts")},iconName:"contacts",message:cjBasics.lang.i18n("cj_i18n_01286","Before you can use this page, you need to give access to load your Google Contacts"),actionLabel:cjBasics.lang.i18n("cj_i18n_01916","Continue with Google"),actionG:!0,action:function(){cjgApis.auth.requestPermissions(s.account,e.cjg_missing_scopes)}}),n=B();t.appendChild(n),r.appendChild(t)})}()});